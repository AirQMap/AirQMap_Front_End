<!DOCTYPE html>
<html>
<head>
    <title>AirQMap</title>
    <meta content='text/html; charset=utf-8' http-equiv='Content-Type'>
    <style type='text/css'>
    body{margin:0;padding:0;overflow:hidden;font-family:'Segoe UI',Helvetica,Arial,Sans-Serif}
    </style>
    <script async defer src="http://www.bing.com/api/maps/mapcontrol?key=ArSyAqCFpDbMrF8monFxY9PomZbiBHLhUJ3sFFZeNBLI_b8Rr3J0TUDHSAjkc3AG&callback=loadMapScenario" type="application/javascript">
    </script>
</head>
<body>
    <div id='myMap' style='width: 100vw; height: 100vh;'></div>
    <script type='text/javascript'>
        async function loadMapScenario() {
            var map = new Microsoft.Maps.Map(document.getElementById('myMap'), {center: new Microsoft.Maps.Location(47.530098, 21.626017), zoom: 15 });
            Microsoft.Maps.loadModule('Microsoft.Maps.DataBinning', async () => {
                var pushpins = new Array();
                await fetch('http://airqmap.divaldo.hu/sql.php').then(
                    resp => (resp.json())
                ).then(
                    resp => {
                        var locations = []; 
                        resp.forEach(element => {
                            pushpins.push(
                                new Microsoft.Maps.Pushpin(
                                    new Microsoft.Maps.Location(
                                        element.latitude, 
                                        element.longtitude
                                    ),
                                    {
                                        color: getColor(element.temperature)
                                    }
                                )
                            );
                        });
                    }
                );
                var layer = new Microsoft.Maps.DataBinningLayer(
                    pushpins,
                    {
                        dataBinType: Microsoft.Maps.DataBinType.circle,
                        radius: 3,
                        distanceUnits: Microsoft.Maps.SpatialMath.DistanceUnits.Meters,
                        polygonOptions: {
                            strokeColor: 'rgba(0, 0, 0, 0)'
                        }
                    }
                );
                console.log('1');
                map.layers.insert(layer);
            });
        }
        function getColor(data) {
            var r, g, b;
            if(data > 0) {
                r = data * 6.375;
                g = 255 - data * 6.375;
                b = 0;
            } else if(data < 0) {
                r = 0;
                g = 255 - data * 6.375;
                b = data * 6.375;
            }
            return `rgba(${r},${g},${b},255)`;
        }
    </script>
</body>
</html>